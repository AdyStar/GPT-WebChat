<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.H.C AI WebChat</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .button-group button {
            margin-left: 10px;
        }

        .chat-box {
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 500px;
            overflow-y: scroll;
        }

        .dark-mode .chat-box {
            background-color: #333;
            color: #fff;
        }

        .user-message, .bot-response {
            margin-bottom: 10px;
        }

        .user-message strong {
            color: blue;
        }

        .bot-response strong {
            color: red;
        }

        pre {
            position: relative;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            overflow-x: auto;
        }

        body.dark-mode pre {
            background-color: #444;
            color: white;
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

        .list-group-item.active {
            background-color: #007bff;
            border-color: #007bff;
        }

        .dark-mode .list-group-item {
            background-color: #333;
            color: #fff;
        }

        .dark-mode .list-group-item.active {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        #chat-history {
            max-height: 400px; /* Define a height for the chat history panel */
            overflow-y: auto; /* Enable vertical scrolling when content overflows */
            padding-right: 15px; /* Add padding to prevent scrollbar overlap */
            display: flex;
            flex-direction: column;
        }

        .list-group-item {
            cursor: pointer;
        }

        .custom-switch {
            display: flex;
            align-items: center;
        }

        .custom-switch .custom-control-label {
            margin-left: 10px;
        }

        .command-line {
            background-color: #e8e8e8;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        /* Custom Prism CSS for dark mode */
        .dark-mode .token.operator,
        .dark-mode .token.punctuation {
            color: #f8f8f2;
        }

        .image-container {
            text-align: center;
            margin-bottom: 10px;
        }

        .dall-e-image {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-3">
                <div class="d-flex justify-content-between align-items-center mb-3 button-group">
                    <h4>Chat History</h4>
                    <button class="btn btn-success" id="new-chat">New</button>
                    <button class="btn btn-danger" id="delete-chat">Delete</button>
                </div>
                <ul class="list-group" id="chat-history"></ul>
            </div>
            <div class="col-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1>T.H.C AI</h1>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-info mr-2" id="join-discord">Support</button>
                        <select class="form-control mr-2" id="model-select">
                            <option value="gpt-3.5-turbo">GPT-3.5-turbo</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="dall-e-3">DALL-E 3</option>
                        </select>                                                
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="dark-mode-switch">
                            <label class="custom-control-label" for="dark-mode-switch">Dark/Light</label>
                        </div>
                    </div>
                </div>
                <div class="chat-box" id="chat-box"></div>
                <form id="bot-form" class="mt-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="user-input" placeholder="Type your message here..." required>
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">Send</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        $(document).ready(function() {
            // Initialize mode based on localStorage
            if (localStorage.getItem('darkMode') === 'true') {
                $('body').addClass('dark-mode');
                $('#dark-mode-switch').prop('checked', true);
            }

            let sessionCounter = localStorage.getItem('sessionCounter') ? parseInt(localStorage.getItem('sessionCounter')) : 0;
            let currentSessionId = null;
            let chatSessions = JSON.parse(localStorage.getItem('chatSessions')) || {};

            const chatBox = $('#chat-box');
            const chatHistory = $('#chat-history');
            const maxVisibleChats = 5;

            function scrollToBottom() {
                chatBox.scrollTop(chatBox[0].scrollHeight);
            }

            function isImageUrl(url) {
                return typeof url === 'string' && (url.includes('&rsct=image/') || url.endsWith('.jpg') || url.endsWith('.jpeg') || url.endsWith('.png') || url.endsWith('.gif'));
            }

            function ensureImageLoaded(element) {
                return new Promise((resolve) => {
                    if (element.complete) {
                        resolve();
                    } else {
                        element.onload = resolve;
                        element.onerror = resolve;
                    }
                });
            }

            function saveChatSessions() {
                localStorage.setItem('chatSessions', JSON.stringify(chatSessions));
                localStorage.setItem('sessionCounter', sessionCounter);
            }

            function getChatTitle(message) {
                return message.split(' ').slice(0, 5).join(' ') + '...';
            }

            function createNewChatSession() {
                sessionCounter++;
                currentSessionId = 'session_' + sessionCounter;
                chatSessions[currentSessionId] = [];

                const newChatItem = $('<li class="list-group-item">New Chat</li>');
                newChatItem.attr('data-session-id', currentSessionId);
                chatHistory.append(newChatItem);

                $('.list-group-item').removeClass('active');
                newChatItem.addClass('active');

                chatBox.empty();
                chatBox.append('<div class="system-message">New chat started.</div>');
                scrollToBottom();
                saveChatSessions();
                updateScrollBehavior();
            }

            function loadChatSessions() {
                chatHistory.empty();
                for (let sessionId in chatSessions) {
                    const firstMessage = chatSessions[sessionId][0] ? chatSessions[sessionId][0].content : 'New Chat';
                    const chatTitle = getChatTitle(firstMessage);
                    const chatItem = $('<li class="list-group-item">' + chatTitle + '</li>');
                    chatItem.attr('data-session-id', sessionId);
                    chatHistory.append(chatItem);
                }
                updateScrollBehavior();
            }

            function updateScrollBehavior() {
                if (chatHistory.children().length > maxVisibleChats) {
                    chatHistory.addClass('scrollable');
                } else {
                    chatHistory.removeClass('scrollable');
                }
            }

            function highlightCodeBlocks() {
                Prism.highlightAll();
                chatBox.find('.copy-button').remove();
                chatBox.find('pre').append('<button class="copy-button">Copy</button>');
            }

            function formatResponseText(text) {
                text = text.replace(/\*\*(.*?)\*\*/g, function(match, p1) {
                    return `<strong>${p1}</strong>`;
                });

                if (isImageUrl(text)) {
                    return `<div class="image-container"><img src="${text}" class="dall-e-image"></div>`;
                }

                text = text.replace(/```python([\s\S]*?)```/g, function(match, p1) {
                    return `<pre><code class="language-python">${p1}</code></pre>`;
                });

                text = text.replace(/`(pip install [\w-]+)`/g, function(match, p1) {
                    return `<span class="command-line">${p1}</span>`;
                });

                text = text.replace(/(\d+\.\s)/g, function(match, p1) {
                    return `<br>${p1}`;
                });

                return text;
            }

            $('#bot-form').on('submit', async function(event) {
                event.preventDefault();
                const userInput = $('#user-input').val();
                $('#user-input').val('');

                chatBox.append('<div class="user-message"><strong>You:</strong> ' + userInput + '</div>');
                scrollToBottom();

                const selectedModel = $('#model-select').val();
                const endpoint = selectedModel === 'gpt-4o' ? '/bot-gpt4o' : selectedModel === 'dall-e-3' ? '/bot-dall-e-3' : '/bot';

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userInput, session_id: currentSessionId, history: chatSessions[currentSessionId] })
                    });

                    const data = await response.json();

                    let botContent;
                    if (selectedModel === 'dall-e-3') {
                        if (data.image_url) {
                            botContent = data.image_url;
                        } else {
                            botContent = 'Error generating image';
                        }
                    } else {
                        botContent = data.response;
                    }

                    const formattedContent = formatResponseText(botContent);
                    const botMessageElement = $('<div class="bot-response"><strong>Bot:</strong> ' + formattedContent + '</div>');
                    chatBox.append(botMessageElement);

                    if (selectedModel === 'dall-e-3' && isImageUrl(botContent)) {
                        const imageElement = botMessageElement.find('img')[0];
                        await ensureImageLoaded(imageElement);
                    }

                    chatSessions[currentSessionId].push({ role: 'user', content: userInput });
                    chatSessions[currentSessionId].push({ role: 'assistant', content: botContent });
                    saveChatSessions();

                    const firstMessage = chatSessions[currentSessionId][0].content;
                    const chatTitle = getChatTitle(firstMessage);
                    chatHistory.find('[data-session-id="' + currentSessionId + '"]').text(chatTitle);

                    highlightCodeBlocks();
                    scrollToBottom();
                } catch (error) {
                    console.error('Error:', error);
                    chatBox.append('<div class="bot-response"><strong>Bot:</strong> An error occurred while processing your request.</div>');
                    scrollToBottom();
                }
            });

            $('#chat-box').on('click', '.copy-button', function() {
                const codeBlock = $(this).siblings('code')[0];
                const range = document.createRange();
                range.selectNodeContents(codeBlock);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand('copy');
                selection.removeAllRanges();
                alert('Code copied to clipboard!');
            });

            $('#dark-mode-switch').on('change', function() {
                if ($(this).is(':checked')) {
                    $('body').addClass('dark-mode');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    $('body').removeClass('dark-mode');
                    localStorage.setItem('darkMode', 'false');
                }
                Prism.highlightAll();
            });

            $('#join-discord').on('click', function() {
                window.location.href = 'https://discord.com/invite/U4HBCHzm7r';
            });

            $('#new-chat').on('click', function() {
                createNewChatSession();
            });

            $('#delete-chat').on('click', function() {
                if (currentSessionId) {
                    delete chatSessions[currentSessionId];
                    saveChatSessions();
                    loadChatSessions();
                    currentSessionId = null;
                    chatBox.empty();
                    chatBox.append('<div class="system-message">Chat deleted. Please select or start a new chat.</div>');
                    scrollToBottom();
                }
            });

            $(document).on('click', '.list-group-item', function() {
                $('.list-group-item').removeClass('active');
                $(this).addClass('active');

                currentSessionId = $(this).data('session-id');
                chatBox.empty();

                chatSessions[currentSessionId].forEach(message => {
                    if (message.role === 'user') {
                        chatBox.append('<div class="user-message"><strong>You:</strong> ' + message.content + '</div>');
                    } else {
                        const formattedContent = formatResponseText(message.content);
                        const botMessageElement = $('<div class="bot-response"><strong>Bot:</strong> ' + formattedContent + '</div>');
                        chatBox.append(botMessageElement);

                        if (isImageUrl(message.content)) {
                            const imageElement = botMessageElement.find('img')[0];
                            ensureImageLoaded(imageElement);
                        }
                    }
                });

                highlightCodeBlocks();
                scrollToBottom();
            });

            loadChatSessions();

            const firstSessionItem = chatHistory.find('.list-group-item').first();
            if (firstSessionItem.length > 0) {
                firstSessionItem.trigger('click');
            } else {
                createNewChatSession();
            }

            scrollToBottom();
        });
    </script>
</body>
</html>
